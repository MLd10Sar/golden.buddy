<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoldenBuddy - Connect with Neighbors</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #2D5A4A;
            --secondary: #F5E6D3;
            --accent: #E8985E;
            --background: #FFFDF9;
            --text-primary: #1A1A1A;
            --text-secondary: #5A5A5A;
            --online: #4CAF50;
            --offline: #9E9E9E;
            --danger: #C62828;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            font-size: 18px;
            line-height: 1.6;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            background: var(--background);
        }

        .view {
            display: none;
            padding: 24px;
            padding-top: 80px;
            min-height: 100vh;
            animation: fadeIn 300ms ease;
        }

        .view.active { display: block; }

        .view.no-statusbar {
            padding-top: 24px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 { font-size: 32px; font-weight: 800; color: var(--primary); margin-bottom: 16px; }
        h2 { font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 12px; }
        h3 { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        p { margin-bottom: 16px; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 32px;
            font-size: 20px;
            font-weight: 700;
            font-family: inherit;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 200ms ease;
            text-decoration: none;
        }

        .btn:hover { transform: scale(1.02); }
        .btn:active { transform: scale(0.98); }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #234a3c; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-accent:hover { background: #d4864d; }
        .btn-outline { background: transparent; border: 3px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-small { padding: 10px 20px; font-size: 16px; }
        .btn-full { width: 100%; }

        .card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
        }

        .input-group { margin-bottom: 24px; }

        label {
            display: block;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        input, select {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-family: inherit;
            border: 3px solid var(--secondary);
            border-radius: 12px;
            background: white;
            color: var(--text-primary);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 20px;
            background: var(--danger);
            color: white;
        }

        .online-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--offline);
            display: inline-block;
        }

        .online-dot.active {
            background: var(--online);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-bar {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 480px;
            width: 100%;
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            display: none;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            z-index: 100;
        }

        .status-bar.visible { display: flex; }

        .activity-icons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .activity-btn {
            flex: 1;
            padding: 20px 12px;
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            border: 3px solid var(--secondary);
            border-radius: 16px;
            background: white;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 200ms ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .activity-btn .icon { font-size: 28px; }
        .activity-btn:hover { border-color: var(--primary); color: var(--primary); }
        .activity-btn.selected { background: var(--primary); border-color: var(--primary); color: white; }
        .activity-btn[data-activity="Walking"].selected { background: #4CAF50; border-color: #4CAF50; }
        .activity-btn[data-activity="Chess"].selected { background: #5C6BC0; border-color: #5C6BC0; }
        .activity-btn[data-activity="Coffee"].selected { background: #FF7043; border-color: #FF7043; }
        .activity-btn[data-activity="Bingo"].selected { background: #E91E63; border-color: #E91E63; }
        .activity-btn[data-activity="Books"].selected { background: #9C27B0; border-color: #9C27B0; }
        .activity-btn[data-activity="Exercise"].selected { background: #00BCD4; border-color: #00BCD4; }
        .activity-btn[data-activity="BoardGames"].selected { background: #795548; border-color: #795548; }
        .activity-btn[data-activity="Dancing"].selected { background: #FF5722; border-color: #FF5722; }
        .activity-btn[data-activity="Art"].selected { background: #CDDC39; border-color: #CDDC39; color: #333; }
        .activity-btn[data-activity="Gardening"].selected { background: #8BC34A; border-color: #8BC34A; }
        .activity-btn[data-activity="Swimming"].selected { background: #3F51B5; border-color: #3F51B5; }

        .neighbor-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 12px;
        }

        .neighbor-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .neighbor-info { flex: 1; }
        .neighbor-name { font-weight: 700; font-size: 18px; }
        .neighbor-activity { font-size: 16px; color: var(--text-secondary); }
        .neighbor-status { font-size: 14px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: var(--secondary);
            padding: 6px;
            border-radius: 10px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
        }

        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 24px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 24px;
            max-width: 420px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalIn 300ms ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal h2 { margin-bottom: 16px; }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-actions .btn { flex: 1; }

        .connection-room { text-align: center; }

        .buddy-card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: var(--shadow);
            margin: 24px 0;
        }

        .buddy-emoji { font-size: 72px; margin-bottom: 16px; }
        .buddy-name { font-size: 28px; font-weight: 800; color: var(--primary); }

        .daily-color {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: var(--secondary);
            padding: 12px 24px;
            border-radius: 30px;
            margin-top: 16px;
            font-size: 20px;
            font-weight: 700;
        }

        .daily-color .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .welcome-logo { text-align: center; margin-bottom: 32px; }
        .welcome-logo .emoji { font-size: 72px; margin-bottom: 16px; }
        .welcome-logo h1 { font-size: 36px; }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }

        .feature-icon { font-size: 28px; }

        .empty-state {
            text-align: center;
            padding: 32px;
            color: var(--text-secondary);
        }

        .empty-state .icon { font-size: 48px; margin-bottom: 12px; }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .notification {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 420px;
            width: calc(100% - 48px);
            padding: 16px 24px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-weight: 600;
            z-index: 300;
            animation: slideUp 300ms ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        .notification.error { background: var(--danger); }
        .notification.success { background: var(--online); }
        .notification.invite { background: var(--accent); }

        .invite-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--accent);
        }

        .invite-item.pending { border-left-color: var(--accent); }
        .invite-item.accepted { border-left-color: var(--online); }
        .invite-item.declined { border-left-color: var(--danger); }
        .invite-item.sent { border-left-color: var(--primary); }

        .invite-item-info h4 { font-size: 18px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .invite-item-info p { font-size: 14px; color: var(--text-secondary); margin: 0; }

        .invite-actions { display: flex; gap: 8px; }

        .history-item {
            padding: 12px;
            background: var(--secondary);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .history-item.sent { border-left: 4px solid var(--accent); }
        .history-item.received { border-left: 4px solid var(--primary); }
        .history-item .time { font-size: 12px; color: var(--text-secondary); }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
        }

        .profile-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
        }

        .profile-info h3 { margin: 0; font-size: 22px; }
        .profile-info p { margin: 0; font-size: 14px; color: var(--text-secondary); }

        .menu-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-top: 8px;
        }

        .header-row h2 {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="status-bar" id="statusBar">
            <div style="display:flex;align-items:center;gap:8px">
                <span class="online-dot active" id="heartbeatDot"></span>
                <span id="userStatus">Looking</span>
            </div>
            <span id="currentArea">-</span>
            <div style="display:flex;align-items:center;gap:8px">
                <button onclick="showEmergencyModal()" style="background:#C62828;border:none;color:white;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:bold;display:flex;align-items:center;gap:4px" title="Emergency">üö® Emergency</button>
                <button onclick="refreshNeighbors()" style="background:none;border:none;color:white;font-size:16px" title="Refresh">üîÑ</button>
                <button onclick="toggleStatus()" id="statusToggle" style="background:#4CAF50;border:none;color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold" title="Toggle status">üü¢</button>
                <button class="menu-btn" onclick="showProfile()" style="background:none;border:none;color:white;font-size:20px">üë§</button>
            </div>
        </div>

        <!-- Welcome View -->
        <div class="view active" id="welcomeView">
            <div class="welcome-logo">
                <div class="emoji">üåü</div>
                <h1>GoldenBuddy</h1>
                <p style="color:var(--text-secondary)">Connect with neighbors nearby</p>
            </div>

            <div class="feature-item">
                <span class="feature-icon">üîí</span>
                <div><strong>Private</strong><p style="margin:0;font-size:14px;color:var(--text-secondary)">No tracking, no GPS</p></div>
            </div>
            <div class="feature-item">
                <span class="feature-icon">üõ°Ô∏è</span>
                <div><strong>Safe</strong><p style="margin:0;font-size:14px;color:var(--text-secondary)">Meet at public places</p></div>
            </div>
            <div class="feature-item">
                <span class="feature-icon">‚ö°</span>
                <div><strong>Real-time</strong><p style="margin:0;font-size:14px;color:var(--text-secondary)">See who's online now</p></div>
            </div>

            <button class="btn btn-primary btn-full" onclick="goToSetup()">Get Started</button>
            <button class="btn btn-outline btn-full" style="margin-top:8px" onclick="showWelcomeTips()">Learn How It Works</button>
        </div>

        <!-- Welcome Tips Modal -->
        <div class="modal-overlay" id="welcomeTipsModal">
            <div class="modal" style="max-height:95vh;overflow-y:auto;padding:20px">
                <div style="text-align:center;margin-bottom:24px">
                    <div style="font-size:64px;margin-bottom:12px">üëã</div>
                    <h2 style="font-size:28px;margin-bottom:8px">Welcome to GoldenBuddy!</h2>
                    <p style="color:var(--text-secondary);margin:0">Let's learn how to use the app</p>
                </div>
                
                <!-- Step Cards -->
                <div style="margin-bottom:24px">
                    <!-- Step 1 -->
                    <div style="background:white;border-radius:16px;padding:20px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:flex;align-items:center;gap:16px">
                        <div style="background:#E8F5E9;width:60px;height:60px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px">üîç</div>
                        <div>
                            <h3 style="margin:0 0 4px 0;color:var(--primary)">1. Find Neighbors</h3>
                            <p style="margin:0;font-size:14px;color:var(--text-secondary)">See who's online in your area. <span style="background:#4CAF50;width:8px;height:8px;border-radius:50%;display:inline-block"></span> Green = Online now!</p>
                        </div>
                    </div>
                    
                    <!-- Step 2 -->
                    <div style="background:white;border-radius:16px;padding:20px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:flex;align-items:center;gap:16px">
                        <div style="background:#FFF3E0;width:60px;height:60px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px">üì®</div>
                        <div>
                            <h3 style="margin:0 0 4px 0;color:var(--primary)">2. Send Invite</h3>
                            <p style="margin:0;font-size:14px;color:var(--text-secondary)">Tap "Invite" on someone's card to ask them to meet up.</p>
                        </div>
                    </div>
                    
                    <!-- Step 3 -->
                    <div style="background:white;border-radius:16px;padding:20px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:flex;align-items:center;gap:16px">
                        <div style="background:#E3F2FD;width:60px;height:60px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px">üì¨</div>
                        <div>
                            <h3 style="margin:0 0 4px 0;color:var(--primary)">3. Check Inbox</h3>
                            <p style="margin:0;font-size:14px;color:var(--text-secondary)">Check your inbox for invites. Tap Accept when you're ready!</p>
                        </div>
                    </div>
                    
                    <!-- Step 4 -->
                    <div style="background:white;border-radius:16px;padding:20px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:flex;align-items:center;gap:16px">
                        <div style="background:#FCE4EC;width:60px;height:60px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px">ü§ù</div>
                        <div>
                            <h3 style="margin:0 0 4px 0;color:var(--primary)">4. Meet Safely</h3>
                            <p style="margin:0;font-size:14px;color:var(--text-secondary)">Always meet at public places. Tell family where you're going!</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Tips -->
                <div style="background:linear-gradient(135deg, var(--primary) 0%, #1a3a2e 100%);border-radius:16px;padding:20px;margin-bottom:20px">
                    <h3 style="color:white;margin:0 0 12px 0;font-size:18px">üí° Quick Tips</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                        <div style="color:rgba(255,255,255,0.9);font-size:14px">‚≠ê Favorite neighbors</div>
                        <div style="color:rgba(255,255,255,0.9);font-size:14px">üìù Add notes</div>
                        <div style="color:rgba(255,255,255,0.9);font-size:14px">üü¢ Status toggle</div>
                        <div style="color:rgba(255,255,255,0.9);font-size:14px">üîÑ Refresh list</div>
                    </div>
                </div>

                <button class="btn btn-primary btn-full" style="padding:20px;font-size:22px" onclick="closeWelcomeTips()">Let's Go! üöÄ</button>
            </div>
        </div>

        <!-- Setup View -->
        <div class="view" id="setupView">
            <h1>Create Profile</h1>
            <p>Tell us about yourself</p>

            <div class="input-group">
                <label for="nameInput">Your Name</label>
                <input type="text" id="nameInput" placeholder="Enter your name" maxlength="20">
            </div>

            <div class="input-group">
                <label for="stateSelect">Your State</label>
                <select id="stateSelect" onchange="updateAreas()">
                    <option value="">Select state...</option>
                    <option value="VA">Virginia</option>
                    <option value="MD">Maryland</option>
                    <option value="DC">Washington D.C.</option>
                </select>
            </div>

            <div class="input-group">
                <label for="areaSelect">Your Area</label>
                <select id="areaSelect">
                    <option value="">Select area...</option>
                </select>
            </div>

            <div class="input-group">
                <label>What do you like to do? (select multiple)</label>
                <div class="activity-grid" id="activityGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
                    <button class="activity-btn" data-activity="Walking" onclick="toggleActivity(this)">
                        <span class="icon">üö∂</span><span>Walking</span>
                    </button>
                    <button class="activity-btn" data-activity="Chess" onclick="toggleActivity(this)">
                        <span class="icon">‚ôüÔ∏è</span><span>Chess</span>
                    </button>
                    <button class="activity-btn" data-activity="Coffee" onclick="toggleActivity(this)">
                        <span class="icon">‚òï</span><span>Coffee/Tea</span>
                    </button>
                    <button class="activity-btn" data-activity="Bingo" onclick="toggleActivity(this)">
                        <span class="icon">üé±</span><span>Bingo</span>
                    </button>
                    <button class="activity-btn" data-activity="Books" onclick="toggleActivity(this)">
                        <span class="icon">üìö</span><span>Book Club</span>
                    </button>
                    <button class="activity-btn" data-activity="Exercise" onclick="toggleActivity(this)">
                        <span class="icon">üßò</span><span>Exercise</span>
                    </button>
                    <button class="activity-btn" data-activity="BoardGames" onclick="toggleActivity(this)">
                        <span class="icon">üé≤</span><span>Board Games</span>
                    </button>
                    <button class="activity-btn" data-activity="Dancing" onclick="toggleActivity(this)">
                        <span class="icon">üíÉ</span><span>Dancing</span>
                    </button>
                    <button class="activity-btn" data-activity="Art" onclick="toggleActivity(this)">
                        <span class="icon">üé®</span><span>Art/Painting</span>
                    </button>
                    <button class="activity-btn" data-activity="Gardening" onclick="toggleActivity(this)">
                        <span class="icon">üå±</span><span>Gardening</span>
                    </button>
                    <button class="activity-btn" data-activity="Swimming" onclick="toggleActivity(this)">
                        <span class="icon">üèä</span><span>Swimming</span>
                    </button>
                </div>
            </div>

            <button class="btn btn-primary btn-full" onclick="completeSetup()">Start Connecting</button>
        </div>

        <!-- Dashboard View -->
        <div class="view" id="dashboardView">
            <div class="header-row">
                <h2>Neighbors</h2>
                <div>
                    <button class="btn btn-small btn-outline" onclick="showInbox()" style="padding:8px 16px">
                        üì¨ <span id="inviteCount" class="badge" style="display:none">0</span>
                    </button>
                </div>
            </div>

            <div class="tabs" id="activityTabs">
                <button class="tab active" onclick="filterActivity('all',this)">All</button>
                <button class="tab" onclick="filterActivity('Walking',this)">üö∂</button>
                <button class="tab" onclick="filterActivity('Chess',this)">‚ôüÔ∏è</button>
                <button class="tab" onclick="filterActivity('Coffee',this)">‚òï</button>
                <button class="tab" onclick="filterActivity('Bingo',this)">üé±</button>
                <button class="tab" onclick="filterActivity('Books',this)">üìö</button>
            </div>

            <div id="neighborsList">
                <div class="empty-state">
                    <div class="icon">üîç</div>
                    <p>Looking for neighbors...</p>
                </div>
            </div>

            <!-- Feedback Button -->
            <div style="position:fixed;bottom:80px;right:24px;z-index:90">
                <button class="btn" style="background:#9C27B0;color:white;border-radius:50%;width:56px;height:56px;padding:0;font-size:24px;box-shadow:0 4px 12px rgba(0,0,0,0.3)" onclick="showFeedbackModal()" title="Send Feedback">
                    üí¨
                </button>
            </div>
        </div>

        <!-- Inbox Modal -->
        <div class="modal-overlay" id="inboxModal">
            <div class="modal">
                <h2>üì¨ Invites</h2>
                <div class="tabs" id="inboxTabs" style="margin-bottom:16px">
                    <button class="tab active" onclick="switchInboxTab('received',this)">Received</button>
                    <button class="tab" onclick="switchInboxTab('sent',this)">Sent</button>
                    <button class="tab" onclick="switchInboxTab('history',this)">History</button>
                </div>
                <div id="invitesList"></div>
                <div class="modal-actions">
                    <button class="btn btn-outline btn-full" onclick="closeInbox()">Close</button>
                </div>
            </div>
        </div>

        <!-- Safety Modal -->
        <div class="modal-overlay" id="safetyModal">
            <div class="modal">
                <h2>üõ°Ô∏è Safety First</h2>
                
                <div style="background:#FFF3E0;padding:16px;border-radius:12px;margin-bottom:16px">
                    <p style="margin:0;font-weight:600;color:#E65100">Before you connect:</p>
                </div>

                <h3>‚úÖ Always:</h3>
                <ul style="margin-left:20px;margin-bottom:16px;font-size:16px">
                    <li>Meet in public places (libraries, parks)</li>
                    <li>Tell a family member where you're going</li>
                    <li>Trust your instincts</li>
                </ul>

                <h3>‚õî Never:</h3>
                <ul style="margin-left:20px;margin-bottom:16px;font-size:16px">
                    <li>Share financial info</li>
                    <li>Invite to home on first meet</li>
                    <li>Accept rides from strangers</li>
                </ul>

                <h3>üìç Suggested Spots:</h3>
                <div id="suggestedSpots" style="font-size:14px;color:var(--text-secondary);margin-bottom:16px">
                    ‚Ä¢ Arlington Central Library<br>
                    ‚Ä¢ Alexandria Library<br>
                    ‚Ä¢ Lubber Run Park
                </div>

                <div class="modal-actions">
                    <button class="btn btn-outline btn-full" onclick="closeSafetyModal()">Cancel</button>
                    <button class="btn btn-accent btn-full" id="safetyProceedBtn">I Understand, Continue</button>
                </div>
            </div>
        </div>

        <!-- Invite Modal -->
        <div class="modal-overlay" id="inviteModal">
            <div class="modal" style="text-align:center">
                <div style="font-size:48px;margin-bottom:8px">üì®</div>
                <h2>Send Invite</h2>
                
                <div class="buddy-card" style="padding:24px;margin:16px 0;text-align:center">
                    <div class="profile-avatar" id="inviteBuddyAvatar" style="width:72px;height:72px;font-size:32px;margin:0 auto 12px">A</div>
                    <div class="buddy-name" id="inviteBuddyName" style="font-size:22px;font-weight:bold">-</div>
                    <p id="inviteBuddyActivity" style="margin:8px 0 0;color:var(--text-secondary)">-</p>
                </div>
                
                <div style="background:#F5F5F5;border-radius:12px;padding:16px;margin-bottom:16px">
                    <p style="margin:0;font-size:16px">Activity: <strong id="inviteActivityName">-</strong></p>
                </div>

                <p style="font-size:16px">Send an invite to connect?</p>
                
                <div class="modal-actions" style="flex-direction:column;gap:12px">
                    <div style="display:flex;gap:12px">
                        <button class="btn btn-outline" style="flex:1" onclick="closeInviteModal()">Cancel</button>
                        <button class="btn btn-accent" style="flex:1" onclick="showSafetyModal('send')">üì® Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile View -->
        <div class="modal-overlay" id="profileModal">
            <div class="modal">
                <h2>üë§ My Profile</h2>
                
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">A</div>
                    <div class="profile-info">
                        <h3 id="profileName">-</h3>
                        <p id="profileArea">-</p>
                    </div>
                </div>

                <button class="btn btn-outline btn-full" onclick="showEditProfile()" style="margin-bottom:16px">‚úèÔ∏è Edit Profile</button>

                <h3>Invite History</h3>
                <div id="historyList" style="max-height:150px;overflow-y:auto;margin-bottom:16px"></div>

                <div class="modal-actions">
                    <button class="btn btn-outline btn-full" onclick="closeProfile()">Close</button>
                    <button class="btn btn-danger btn-full" onclick="logout()">Sign Out</button>
                </div>
            </div>
        </div>

        <!-- Edit Profile Modal -->
        <div class="modal-overlay" id="editProfileModal">
            <div class="modal">
                <h2>‚úèÔ∏è Edit Profile</h2>
                
                <div class="input-group">
                    <label>Your Name</label>
                    <input type="text" id="editNameInput" maxlength="20">
                </div>

                <div class="input-group">
                    <label>Your State</label>
                    <select id="editStateSelect" onchange="updateEditAreas()">
                        <option value="VA">Virginia</option>
                        <option value="MD">Maryland</option>
                        <option value="DC">Washington D.C.</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Your Area</label>
                    <select id="editAreaSelect"></select>
                </div>

                <div class="input-group">
                    <label>What do you like to do? (select multiple)</label>
                    <div class="activity-grid" id="editActivityIcons" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
                        <button class="activity-btn" data-activity="Walking" onclick="toggleEditActivity(this)">
                            <span class="icon">üö∂</span><span>Walking</span>
                        </button>
                        <button class="activity-btn" data-activity="Chess" onclick="toggleEditActivity(this)">
                            <span class="icon">‚ôüÔ∏è</span><span>Chess</span>
                        </button>
                        <button class="activity-btn" data-activity="Coffee" onclick="toggleEditActivity(this)">
                            <span class="icon">‚òï</span><span>Coffee/Tea</span>
                        </button>
                        <button class="activity-btn" data-activity="Bingo" onclick="toggleEditActivity(this)">
                            <span class="icon">üé±</span><span>Bingo</span>
                        </button>
                        <button class="activity-btn" data-activity="Books" onclick="toggleEditActivity(this)">
                            <span class="icon">üìö</span><span>Book Club</span>
                        </button>
                        <button class="activity-btn" data-activity="Exercise" onclick="toggleEditActivity(this)">
                            <span class="icon">üßò</span><span>Exercise</span>
                        </button>
                        <button class="activity-btn" data-activity="BoardGames" onclick="toggleEditActivity(this)">
                            <span class="icon">üé≤</span><span>Board Games</span>
                        </button>
                        <button class="activity-btn" data-activity="Dancing" onclick="toggleEditActivity(this)">
                            <span class="icon">üíÉ</span><span>Dancing</span>
                        </button>
                        <button class="activity-btn" data-activity="Art" onclick="toggleEditActivity(this)">
                            <span class="icon">üé®</span><span>Art</span>
                        </button>
                        <button class="activity-btn" data-activity="Gardening" onclick="toggleEditActivity(this)">
                            <span class="icon">üå±</span><span>Gardening</span>
                        </button>
                        <button class="activity-btn" data-activity="Swimming" onclick="toggleEditActivity(this)">
                            <span class="icon">üèä</span><span>Swimming</span>
                        </button>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-outline" onclick="closeEditProfile()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveEditProfile()">Save</button>
                </div>
            </div>
        </div>

        <!-- Connection Room -->
        <div class="view" id="connectionView">
            <div class="connection-room">
                <div style="text-align:center;margin-bottom:24px">
                    <div style="font-size:64px">üéâ</div>
                    <h2 style="font-size:28px">You're Connected!</h2>
                    <p style="color:var(--text-secondary)">Time to meet your new buddy!</p>
                </div>
                
                <!-- Buddy Card -->
                <div class="buddy-card" style="text-align:center">
                    <div class="profile-avatar" id="buddyAvatar" style="width:80px;height:80px;font-size:36px;margin:0 auto 16px">A</div>
                    <div class="buddy-name" id="buddyName" style="font-size:24px;font-weight:bold">-</div>
                    <p id="buddyActivity" style="margin:8px 0;color:var(--text-secondary)">-</p>
                    
                    <div style="background:var(--secondary);padding:12px;border-radius:12px;margin-top:12px;display:inline-block">
                        <span style="font-weight:bold">üëÄ Look for:</span>
                        <span id="dailyColorText" style="font-size:20px;font-weight:bold;color:var(--primary)">Blue icon</span>
                    </div>
                </div>

                <!-- What to do next -->
                <div style="background:white;border-radius:16px;padding:20px;margin:16px 0;box-shadow:0 2px 8px rgba(0,0,0,0.08)">
                    <h3 style="margin:0 0 16px 0;color:var(--primary)">üìã Next Steps</h3>
                    
                    <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center">
                        <div style="background:#E3F2FD;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#1976D2">1</div>
                        <div style="flex:1">
                            <strong>Text your family</strong>
                            <p style="margin:0;font-size:13px;color:var(--text-secondary)">Let them know where you're going</p>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center">
                        <div style="background:#E8F5E9;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#388E3C">2</div>
                        <div style="flex:1">
                            <strong>Go to meeting spot</strong>
                            <p style="margin:0;font-size:13px;color:var(--text-secondary)">Look for the Blue icon</p>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:12px;align-items:center">
                        <div style="background:#FFF3E0;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#F57C00">3</div>
                        <div style="flex:1">
                            <strong>Have fun!</strong>
                            <p style="margin:0;font-size:13px;color:var(--text-secondary)">Enjoy your activity together</p>
                        </div>
                    </div>
                </div>
                
                <!-- Meeting Spot Section -->
                <div id="meetingSection">
                    <!-- Your Spot -->
                    <div style="background:#E8F5E9;padding:16px;border-radius:12px;margin:16px 0">
                        <h4 style="color:var(--online);margin:0 0 12px 0">üìç Choose Meeting Spot</h4>
                        
                        <select id="meetingSpotSelect" onchange="updateMeetingSpot()" style="width:100%;padding:14px;font-size:16px;border-radius:10px;border:2px solid var(--primary);margin-bottom:8px">
                            <option value="">Select a spot...</option>
                        </select>
                        
                        <p id="meetingSpot" style="margin:0;font-size:18px;font-weight:bold">Select a spot above</p>
                    </div>
                    
                    <!-- Their Spot -->
                    <div id="theirSpotCard" style="background:#FFF3E0;padding:16px;border-radius:12px;margin:16px 0;display:none">
                        <h4 style="color:#E65100;margin:0 0 8px 0">üëÄ Buddy's Suggestion</h4>
                        <p id="theirSpot" style="margin:0;font-size:16px">Waiting for buddy to pick...</p>
                        <button id="acceptTheirSpot" class="btn btn-accent btn-full" style="margin-top:12px;display:none" onclick="acceptTheirSpot()">‚úì Accept This Spot</button>
                    </div>
                    
                    <!-- Time Selection (shown after spot agreed) -->
                    <div id="timeSection" style="display:none">
                        <div style="background:#E3F2FD;padding:16px;border-radius:12px;margin:16px 0">
                            <h4 style="color:#1976D2;margin:0 0 12px 0">‚è∞ Pick a Time</h4>
                            
                            <div style="display:flex;gap:8px;margin-bottom:12px">
                                <select id="meetingHour" style="flex:1;padding:12px;font-size:16px;border-radius:8px">
                                    <option value="">Hour</option>
                                </select>
                                <select id="meetingMinute" style="flex:1;padding:12px;font-size:16px;border-radius:8px">
                                    <option value="">Min</option>
                                </select>
                                <select id="meetingAMPM" style="flex:1;padding:12px;font-size:16px;border-radius:8px">
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                            </div>
                            
                            <button class="btn btn-primary btn-full" onclick="setMeetingTime()">Set Meeting Time</button>
                        </div>
                        
                        <!-- Time Confirmation -->
                        <div id="timeConfirmed" style="background:#4CAF50;color:white;padding:16px;border-radius:12px;margin:16px 0;display:none">
                            <h4 style="margin:0 0 8px 0">‚úÖ Meeting Set!</h4>
                            <p id="confirmedTime" style="margin:0;font-size:20px;font-weight:bold"></p>
                            <p id="countdown" style="margin:8px 0 0;font-size:24px;font-weight:bold"></p>
                        </div>
                        
                        <!-- Buddy's Time -->
                        <div id="theirTime" style="background:#FFF3E0;padding:16px;border-radius:12px;margin:16px 0;display:none">
                            <p style="margin:0;font-size:16px" id="theirTimeText"></p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <button class="btn btn-accent btn-full" style="padding:20px;font-size:20px" onclick="textFamily()">
                    üì± Tell Family Where I'm Going
                </button>
                
                <button class="btn btn-outline btn-full" style="margin-top:12px" onclick="endConnection()">
                    End Connection
                </button>
            </div>
        </div>

        <!-- Private Note Modal -->
        <div class="modal-overlay" id="noteModal">
            <div class="modal">
                <h2>üìù Note for <span id="noteModalName">-</span></h2>
                <div class="input-group">
                    <label>Private note (only you can see)</label>
                    <input type="text" id="noteInput" placeholder="e.g., Likes morning walks" maxlength="100">
                </div>
                <div class="modal-actions">
                    <button class="btn btn-outline" onclick="closeNoteModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveNote()">Save</button>
                </div>
            </div>
        </div>

        <!-- Rating Modal -->
        <div class="modal-overlay" id="ratingModal">
            <div class="modal">
                <h2>üëç Rate Your Meetup</h2>
                <p>How was your meetup with <span id="ratingModalName">-</span>?</p>
                <div style="display:flex;gap:12px;margin:24px 0">
                    <button class="btn btn-primary btn-full" onclick="submitRating('good')" style="background:#4CAF50">
                        üëç Good
                    </button>
                    <button class="btn btn-danger btn-full" onclick="submitRating('bad')">
                        üëé Not Good
                    </button>
                </div>
                <button class="btn btn-outline btn-full" onclick="closeRatingModal()">Skip</button>
            </div>
        </div>

        <!-- Feedback Modal -->
        <div class="modal-overlay" id="feedbackModal">
            <div class="modal">
                <h2>üí¨ Send Us Feedback</h2>
                <p style="color:var(--text-secondary);margin-bottom:16px">Help us improve GoldenBuddy! Tell us what you think.</p>
                
                <div class="input-group">
                    <label>How would you rate your experience?</label>
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <button type="button" class="feedback-rating" data-rating="5" onclick="selectFeedbackRating(5)" style="flex:1;padding:12px;border:2px solid var(--secondary);border-radius:8px;background:white;font-size:24px;cursor:pointer">üòç</button>
                        <button type="button" class="feedback-rating" data-rating="4" onclick="selectFeedbackRating(4)" style="flex:1;padding:12px;border:2px solid var(--secondary);border-radius:8px;background:white;font-size:24px;cursor:pointer">üòä</button>
                        <button type="button" class="feedback-rating" data-rating="3" onclick="selectFeedbackRating(3)" style="flex:1;padding:12px;border:2px solid var(--secondary);border-radius:8px;background:white;font-size:24px;cursor:pointer">üòê</button>
                        <button type="button" class="feedback-rating" data-rating="2" onclick="selectFeedbackRating(2)" style="flex:1;padding:12px;border:2px solid var(--secondary);border-radius:8px;background:white;font-size:24px;cursor:pointer">üòï</button>
                        <button type="button" class="feedback-rating" data-rating="1" onclick="selectFeedbackRating(1)" style="flex:1;padding:12px;border:2px solid var(--secondary);border-radius:8px;background:white;font-size:24px;cursor:pointer">üò¢</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="feedbackText">Your feedback (optional)</label>
                    <textarea id="feedbackText" placeholder="Tell us what you like or what we can improve..." style="width:100%;padding:12px;font-size:16px;border:2px solid var(--secondary);border-radius:8px;min-height:100px;font-family:inherit;resize:vertical"></textarea>
                </div>
                
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="feedbackContact" style="margin-right:8px">
                        You can contact me about my feedback
                    </label>
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-outline" onclick="closeFeedbackModal()">Cancel</button>
                    <button class="btn btn-primary" id="submitFeedbackBtn" onclick="submitFeedback()" disabled>Send Feedback</button>
                </div>
            </div>
        </div>

        <!-- Emergency Modal -->
        <div class="modal-overlay" id="emergencyModal">
            <div class="modal" style="border:4px solid #C62828">
                <div style="text-align:center;margin-bottom:20px">
                    <div style="font-size:64px">üö®</div>
                    <h2 style="color:#C62828;margin:0">Emergency</h2>
                    <p style="color:#C62828;font-weight:bold;margin:8px 0 0">Are you in danger?</p>
                </div>
                
                <div style="background:#FFEBEE;padding:16px;border-radius:12px;margin-bottom:20px;border-left:4px solid #C62828">
                    <p style="margin:0;font-size:16px"><strong>If this is a life-threatening emergency:</strong></p>
                    <p style="margin:8px 0 0;font-size:20px;color:#C62828;font-weight:bold">Call 911 immediately</p>
                </div>

                <div style="margin-bottom:20px">
                    <button class="btn btn-full" style="background:#C62828;color:white;padding:20px;font-size:20px;margin-bottom:12px" onclick="callEmergency()">
                        üìû Call 911
                    </button>
                    
                    <button class="btn btn-full" style="background:#FF9800;color:white;padding:16px;font-size:18px;margin-bottom:12px" onclick="textEmergencyContact()">
                        üì± Text Emergency Contact
                    </button>
                    
                    <button class="btn btn-full" style="background:#2196F3;color:white;padding:16px;font-size:18px" onclick="callEmergencyContact()">
                        üìû Call Emergency Contact
                    </button>
                </div>

                <div style="background:#FFF3E0;padding:12px;border-radius:8px;margin-bottom:20px">
                    <p style="margin:0;font-size:14px"><strong>Your Location:</strong> <span id="emergencyLocation">Getting location...</span></p>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-outline btn-full" onclick="closeEmergencyModal()" style="border-color:#C62828;color:#C62828">Cancel - I'm Safe</button>
                </div>
            </div>
        </div>

        <!-- Emergency Contact Setup Modal -->
        <div class="modal-overlay" id="emergencySetupModal">
            <div class="modal">
                <h2>üö® Set Up Emergency Contact</h2>
                <p style="color:var(--text-secondary);margin-bottom:16px">Add someone who should be notified in case of emergency.</p>
                
                <div class="input-group">
                    <label for="emergencyContactName">Contact Name</label>
                    <input type="text" id="emergencyContactName" placeholder="e.g., My Daughter" maxlength="30">
                </div>
                
                <div class="input-group">
                    <label for="emergencyContactPhone">Phone Number</label>
                    <input type="tel" id="emergencyContactPhone" placeholder="e.g., 555-123-4567" maxlength="20">
                </div>
                
                <div style="background:#E8F5E9;padding:12px;border-radius:8px;margin-bottom:16px">
                    <p style="margin:0;font-size:14px">‚úì This information is stored only on your device for privacy</p>
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-outline" onclick="closeEmergencySetupModal()">Skip</button>
                    <button class="btn btn-primary" onclick="saveEmergencyContact()">Save Contact</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <script>
        // Global error handler
        window.onerror = function(msg, url, line) {
            console.error("JS Error:", msg, "Line:", line);
            return false;
        };

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBrwc2Ha0SsyvUs3-TuBPbGljQkFLu7Q8o",
            authDomain: "goldenbuddy-test.firebaseapp.com",
            databaseURL: "https://goldenbuddy-test-default-rtdb.firebaseio.com",
            projectId: "goldenbuddy-test",
            storageBucket: "goldenbuddy-test.firebasestorage.app",
            messagingSenderId: "105279770899",
            appId: "1:105279770899:web:4ab25dcb5700d66743cae6"
        };

        // Initialize Firebase (non-blocking)
        window.db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            window.db = firebase.database();
            console.log("Firebase connected!");
        } catch(e) {
            console.error("Firebase init failed:", e);
        }

        // Move constants here before any functions
        const AREAS_BY_STATE = {
            'VA': {
                'arlington': 'Arlington',
                'alexandria': 'Alexandria',
                'fairfax': 'Fairfax',
                'falls-church': 'Falls Church',
                'vienna': 'Vienna',
                'reston': 'Reston',
                'herndon': 'Herndon',
                'mclean': 'McLean',
                'burke': 'Burke',
                'springfield': 'Springfield',
                'woodbridge': 'Woodbridge',
                'manassas': 'Manassas',
                'leesburg': 'Leesburg',
                'loudoun': 'Loudoun County',
                'centreville': 'Centreville',
                'chanilly': 'Chantilly',
                'fair-oaks': 'Fair Oaks',
                'annandale': 'Annandale',
                'fairfax-station': 'Fairfax Station',
                'kingstowne': 'Kingstowne'
            },
            'MD': {
                'bethesda': 'Bethesda',
                'rockville': 'Rockville',
                'silver-spring': 'Silver Spring',
                'college-park': 'College Park',
                'hyattsville': 'Hyattsville',
                'greenbelt': 'Greenbelt',
                'bowie': 'Bowie',
                'laurel': 'Laurel',
                'waldorf': 'Waldorf'
            },
            'DC': {
                'washington-dc': 'Washington D.C.'
            }
        };

        const SAFE_ZONES = {
            'VA': [
                'Arlington Central Library',
                'Arlington Westover Library',
                'Arlington Shirlington Library',
                'Arlington Aurora Hills Library',
                'Alexandria Central Library',
                'Alexandria Beatley Library',
                'Fairfax Regional Library',
                'Fairfax City Library',
                'Burke Centre Library',
                'Reston Community Center',
                'Reston Library',
                'Vienna Community Center',
                'Vienna Library',
                'Falls Church Library',
                'McLean Library',
                'Herndon Library',
                'Leesburg Library',
                'Lubber Run Park',
                'Walker Branch Park',
                'Great Falls Park',
                'Lake Fairfax Park',
                'Clemyjontri Park',
                'Meadowlark Botanical Gardens',
                'Tysons Corner Center (Food Court)',
                'Fair Oaks Mall (Food Court)'
            ],
            'MD': [
                'Bethesda Library',
                'Rockville Library',
                'Silver Spring Library',
                'College Park Library',
                'Greenbelt Library',
                'Bowie Library',
                'Wheaton Regional Park',
                'Brookside Gardens',
                'Lake Artemesia',
                'Montgomery Mall (Food Court)',
                'White Oak Library'
            ],
            'DC': [
                'Martin Luther King Jr. Library',
                'Georgetown Library',
                'Capitol Hill Library',
                'Woodridge Library',
                'Dupont Circle',
                'The National Mall',
                'Rock Creek Park',
                'Franklin Square Library',
                'Tenleytown Library'
            ]
        };

        // ===== State =====
        let state = {
            userId: null,
            userData: null,
            presenceRef: null,
            presenceInterval: null,
            neighborsRef: null,
            invitesRef: null,
            neighbors: [],
            invites: [],
            connection: null,
            selectedNeighbor: null,
            currentFilter: 'all',
            pendingSafetyAction: null,
            userStatus: 'Looking', // Looking, Busy, Away
            userActivities: [], // Multiple activities
            favorites: {}, // { neighborId: true }
            privateNotes: {}, // { neighborId: "note text" }
            ratings: {}, // { neighborId: { rating: 'good'|'bad', timestamp } }
            connectionHistory: [], // [{ buddyId, buddyName, activity, connectedAt, endedAt }]
            inboxTab: 'received',
            meetingSpotListener: null
        };

        const COLORS = ['Blue', 'Red', 'Green', 'Purple', 'Orange', 'Pink', 'Teal', 'Gold'];

        // ===== Initialization =====
        function init() {
            const saved = localStorage.getItem('goldenbuddy_user');
            if (saved) {
                const userData = JSON.parse(saved);
                state.userId = userData.userId;
                state.userData = userData;
                
                // Load other data
                const savedData = localStorage.getItem('goldenbuddy_data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    state.favorites = data.favorites || {};
                    state.privateNotes = data.privateNotes || {};
                    state.ratings = data.ratings || {};
                    state.connectionHistory = data.connectionHistory || [];
                }
                
                connectToFirebase();
                showView('dashboardView');
            }
        }

        function connectToFirebase() {
            if (!state.userId) return;
            if (!window.db) {
                alert("Firebase not connected! Please check your config.");
                return;
            }

            // Set presence
            state.presenceRef = window.db.ref('presence/' + state.userId);
            state.presenceRef.set({
                name: state.userData.name,
                area: state.userData.area,
                areaName: state.userData.areaName,
                state: state.userData.state,
                activity: state.userData.activity,
                color: getDailyColor(state.userId),
                status: state.userStatus,
                online: true,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                console.log("Presence set!");
            }).catch(err => {
                console.error("Firebase error:", err);
                alert("Firebase error: " + err.message);
            });
            
            state.presenceRef.onDisconnect().remove();

            // Listen to area neighbors
            const area = state.userData.area;
            state.neighborsRef = window.db.ref('presence').orderByChild('area').equalTo(area);
            state.neighborsRef.on('value', (snapshot) => {
                const now = Date.now();
                const neighbors = [];
                snapshot.forEach((child) => {
                    if (child.key !== state.userId) {
                        const data = child.val();
                        // Only show users who were seen in last 60 seconds
                        if (data.lastSeen && (now - data.lastSeen < 65000)) {
                            neighbors.push({ id: child.key, ...data });
                        }
                    }
                });
                state.neighbors = neighbors;
                renderNeighbors();
                document.getElementById('currentArea').textContent = state.userData.areaName || area;
                document.getElementById('statusBar').classList.add('visible');
            }, (error) => {
                console.error("Listen error:", error);
            });

            // Keep presence alive - update every 30 seconds
            if (state.presenceInterval) clearInterval(state.presenceInterval);
            state.presenceInterval = setInterval(() => {
                if (state.presenceRef) {
                    state.presenceRef.update({
                        lastSeen: firebase.database.ServerValue.TIMESTAMP,
                        online: true
                    });
                }
            }, 30000);

            // Listen to invites
            if (window.db) {
                state.invitesRef = window.db.ref('invites/' + state.userId);
                state.invitesRef.on('value', (snapshot) => {
                    const oldInvites = state.invites || [];
                    const oldCount = oldInvites.filter(i => i.status === 'pending' && i.direction !== 'sent').length;
                    
                    const invites = [];
                    snapshot.forEach((child) => {
                        invites.push({ key: child.key, ...child.val() });
                    });
                    state.invites = invites.sort((a,b) => b.timestamp - a.timestamp);
                    updateInviteCount();
                    
                    // Re-render neighbors to update status badges
                    renderNeighbors();
                    
                    // Check for new invites
                    const newPendingCount = (state.invites || []).filter(i => i.status === 'pending' && i.direction !== 'sent').length;
                    if (newPendingCount > oldCount) {
                        const newInvites = (state.invites || []).filter(i => i.status === 'pending' && i.direction !== 'sent');
                        if (newInvites.length > 0) {
                            const latestInvite = newInvites[0];
                            showNotification(`üì® New invite from ${latestInvite.fromName}!`, 'invite');
                        }
                    }
                }, (error) => {
                    console.error('Invites listener error:', error);
                });
            }
            
            // Listen for active connections (when someone accepts your invite)
            if (window.db) {
                // Listen for active connections where user is user1
                window.db.ref('connections').orderByChild('user1').equalTo(state.userId).on('value', (snapshot) => {
                    let foundActive = false;
                    snapshot.forEach((child) => {
                        const conn = child.val();
                        const connectionKey = child.key;
                        
                        if (conn.status === 'active' && conn.user2) {
                            foundActive = true;
                            const buddyId = conn.user2;
                            const buddyName = conn.user2Name;
                            // Check if not already connected
                            if (!state.connection || state.connection.buddyId !== buddyId) {
                                state.connection = {
                                    buddyId: buddyId,
                                    name: buddyName,
                                    activity: conn.activity,
                                    connectedAt: conn.startedAt,
                                    key: connectionKey
                                };
                                renderNeighbors();
                                showNotification('‚úÖ ' + buddyName + ' accepted your invite!', 'success');
                            }
                        } else if (conn.status === 'ended' && state.connection && conn.endedBy) {
                            // Connection was ended by other user
                            if (conn.endedBy.userId !== state.userId) {
                                showNotification(conn.endedBy.name + ' ended the connection', 'error');
                                state.connection = null;
                                renderNeighbors();
                            }
                        }
                    });
                    
                    // If no active connections found but we think we're connected, clear it
                    if (!foundActive && state.connection) {
                        const myConnection = snapshot.val();
                        let stillConnected = false;
                        snapshot.forEach((child) => {
                            if (child.val().status === 'active') stillConnected = true;
                        });
                        if (!stillConnected) {
                            state.connection = null;
                            renderNeighbors();
                        }
                    }
                });
                
                // Listen for active connections where user is user2
                window.db.ref('connections').orderByChild('user2').equalTo(state.userId).on('value', (snapshot) => {
                    let foundActive = false;
                    snapshot.forEach((child) => {
                        const conn = child.val();
                        const connectionKey = child.key;
                        
                        if (conn.status === 'active' && conn.user1) {
                            foundActive = true;
                            const buddyId = conn.user1;
                            const buddyName = conn.user1Name;
                            // Check if not already connected
                            if (!state.connection || state.connection.buddyId !== buddyId) {
                                state.connection = {
                                    buddyId: buddyId,
                                    name: buddyName,
                                    activity: conn.activity,
                                    connectedAt: conn.startedAt,
                                    key: connectionKey
                                };
                                renderNeighbors();
                            }
                        } else if (conn.status === 'ended' && state.connection && conn.endedBy) {
                            // Connection was ended by other user
                            if (conn.endedBy.userId !== state.userId) {
                                showNotification(conn.endedBy.name + ' ended the connection', 'error');
                                state.connection = null;
                                renderNeighbors();
                            }
                        }
                    });
                    
                    // If no active connections found but we think we're connected, clear it
                    if (!foundActive && state.connection) {
                        let stillConnected = false;
                        snapshot.forEach((child) => {
                            if (child.val().status === 'active') stillConnected = true;
                        });
                        if (!stillConnected) {
                            state.connection = null;
                            renderNeighbors();
                        }
                    }
                });
            }
        }

        // ===== Navigation =====
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => {
                v.classList.remove('active');
                v.classList.add('no-statusbar');
            });
            document.getElementById(viewId).classList.add('active');
            document.getElementById(viewId).classList.remove('no-statusbar');
        }

        function goToSetup() { 
            // Check if first time user
            const hasSeenTips = localStorage.getItem('goldenbuddy_seen_tips');
            if (!hasSeenTips) {
                showWelcomeTips();
            } else {
                showView('setupView');
            }
        }

        function showWelcomeTips() {
            document.getElementById('welcomeTipsModal').classList.add('active');
        }

        function closeWelcomeTips() {
            document.getElementById('welcomeTipsModal').classList.remove('active');
            // Check if coming from welcome view
            const hasSeenTips = localStorage.getItem('goldenbuddy_seen_tips');
            if (!hasSeenTips) {
                localStorage.setItem('goldenbuddy_seen_tips', 'true');
                showView('setupView');
            }
        }

        function updateAreas() {
            console.log('updateAreas called');
            const stateSelect = document.getElementById('stateSelect');
            const areaSelect = document.getElementById('areaSelect');
            const selectedState = stateSelect.value;
            
            console.log('Selected state:', selectedState);
            console.log('AREAS_BY_STATE:', AREAS_BY_STATE);
            
            areaSelect.innerHTML = '<option value="">Select area...</option>';
            
            if (selectedState && AREAS_BY_STATE && AREAS_BY_STATE[selectedState]) {
                const areas = AREAS_BY_STATE[selectedState];
                console.log('Found areas:', areas);
                for (const [key, name] of Object.entries(areas)) {
                    const option = document.createElement('option');
                    option.value = selectedState + '|' + key;
                    option.textContent = name;
                    areaSelect.appendChild(option);
                }
            } else {
                console.log('No areas found for state:', selectedState);
            }
        }

        function completeSetup() {
            const name = document.getElementById('nameInput').value.trim();
            const areaValue = document.getElementById('areaSelect').value;
            const stateValue = document.getElementById('stateSelect').value;
            
            if (!name) { showNotification('Please enter your name', 'error'); return; }
            if (!areaValue) { showNotification('Please select your area', 'error'); return; }
            if (state.userActivities.length === 0) { showNotification('Please select at least one activity', 'error'); return; }

            const [stateCode, areaKey] = areaValue.split('|');
            const areaName = AREAS_BY_STATE[stateCode]?.[areaKey] || areaValue;
            
            state.userId = generateId();
            state.userData = { 
                userId: state.userId, 
                name, 
                state: stateCode,
                area: areaValue,
                areaName: areaName,
                activities: state.userActivities,
                activity: state.userActivities[0]
            };
            
            // Load favorites and notes from localStorage
            const savedData = localStorage.getItem('goldenbuddy_data');
            if (savedData) {
                const data = JSON.parse(savedData);
                state.favorites = data.favorites || {};
                state.privateNotes = data.privateNotes || {};
                state.ratings = data.ratings || {};
                state.connectionHistory = data.connectionHistory || [];
            }
            
            localStorage.setItem('goldenbuddy_user', JSON.stringify(state.userData));
            
            connectToFirebase();
            showView('dashboardView');
            showNotification('Welcome, ' + name + '!', 'success');
        }

        function toggleActivity(btn) {
            const activity = btn.dataset.activity;
            const index = state.userActivities.indexOf(activity);
            
            if (index > -1) {
                state.userActivities.splice(index, 1);
                btn.classList.remove('selected');
            } else {
                state.userActivities.push(activity);
                btn.classList.add('selected');
            }
            
            // Set primary activity for display
            state.activity = state.userActivities[0] || 'Walking';
        }

        function selectActivity(btn) {
            // For edit profile - single select
            document.querySelectorAll('#editActivityIcons .activity-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        // ===== Status Toggle =====
        function toggleStatus() {
            const statuses = ['Looking', 'Busy', 'Away'];
            const currentIndex = statuses.indexOf(state.userStatus);
            state.userStatus = statuses[(currentIndex + 1) % statuses.length];
            
            const statusBtn = document.getElementById('statusToggle');
            const statusLabel = document.getElementById('userStatus');
            
            const statusConfig = {
                'Looking': { color: '#4CAF50', emoji: 'üü¢', label: 'Looking' },
                'Busy': { color: '#F44336', emoji: 'üî¥', label: 'Busy' },
                'Away': { color: '#FFC107', emoji: 'üü°', label: 'Away' }
            };
            
            const config = statusConfig[state.userStatus];
            statusBtn.style.background = config.color;
            statusBtn.textContent = config.emoji;
            statusLabel.textContent = config.label;
            
            // Update Firebase presence
            if (state.presenceRef) {
                state.presenceRef.update({ status: state.userStatus });
            }
        }

        // ===== Manual Refresh =====
        function refreshNeighbors() {
            if (state.neighborsRef) {
                state.neighborsRef.once('value', (snapshot) => {
                    const neighbors = [];
                    snapshot.forEach((child) => {
                        if (child.key !== state.userId) {
                            neighbors.push({ id: child.key, ...child.val() });
                        }
                    });
                    state.neighbors = neighbors;
                    renderNeighbors();
                    showNotification('Refreshed!', 'success');
                });
            }
        }

        // ===== Neighbors =====
        function renderNeighbors() {
            const container = document.getElementById('neighborsList');
            let filtered = state.neighbors;

            if (state.currentFilter !== 'all') {
                filtered = filtered.filter(n => {
                    const activities = n.activities || [n.activity];
                    return activities.includes(state.currentFilter);
                });
            }

            // Sort favorites to top
            filtered.sort((a, b) => {
                const aFav = state.favorites[a.id] ? 1 : 0;
                const bFav = state.favorites[b.id] ? 1 : 0;
                return bFav - aFav;
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üòî</div>
                        <p>No neighbors online</p>
                        <p style="font-size:14px">Share the app with friends!</p>
                    </div>`;
                return;
            }

            const activityIcons = { 
                'Walking': 'üö∂', 'Chess': '‚ôüÔ∏è', 'Coffee': '‚òï', 
                'Bingo': 'üé±', 'Books': 'üìö', 'Exercise': 'üßò',
                'BoardGames': 'üé≤', 'Dancing': 'üíÉ', 'Art': 'üé®',
                'Gardening': 'üå±', 'Swimming': 'üèä'
            };
            
            container.innerHTML = filtered.map(n => {
                const activities = n.activities || [n.activity];
                const primaryActivity = activities[0];
                const icon = activityIcons[primaryActivity] || 'üë§';
                const isFav = state.favorites && state.favorites[n.id];
                
                // Check invite status with this neighbor
                const invites = state.invites || [];
                const sentInvite = invites.find(i => i.toId === n.id && i.direction === 'sent');
                const receivedInvite = invites.find(i => i.fromId === n.id && i.direction !== 'sent');
                const isPending = sentInvite && sentInvite.status === 'pending';
                
                // Check if currently connected to this person
                const isConnected = state.connection && state.connection.buddyId === n.id;
                
                // Get all icons for this neighbor
                const activityBadges = activities.map(a => 
                    `<span style="font-size:12px;margin-right:4px">${activityIcons[a] || ''}</span>`
                ).join('');
                
                let statusBadge = '';
                let actionButton = '';
                let cardColor = 'var(--primary)';
                
                if (isConnected) {
                    statusBadge = `<span style="background:#4CAF50;color:white;padding:2px 8px;border-radius:10px;font-size:11px">‚úÖ Connected</span>`;
                    actionButton = `<button class="btn btn-accent btn-small" style="padding:6px 12px;font-size:12px;background:#4CAF50" onclick="enterConnectionWith('${n.id}', '${n.name}', '${primaryActivity}')">Chat</button>`;
                    cardColor = '#4CAF50';
                } else if (isPending) {
                    statusBadge = `<span style="background:#FF9800;color:white;padding:2px 8px;border-radius:10px;font-size:11px">‚è≥ Sent</span>`;
                    actionButton = `<button class="btn btn-outline btn-small" style="padding:6px 12px;font-size:12px" onclick="cancelInvite('${sentInvite.key}', '${n.id}')">Cancel</button>`;
                    cardColor = '#FF9800';
                } else {
                    statusBadge = `<span class="online-dot active"></span> Online now`;
                    actionButton = `<button class="btn btn-accent btn-small" style="padding:6px 12px;font-size:12px" onclick="openInviteModal('${n.id}', '${n.name}', '${primaryActivity}')">Invite</button>`;
                }
                
                return `
                <div class="neighbor-card" style="border-left: 4px solid ${cardColor}">
                    <div class="neighbor-avatar" style="background:${cardColor};color:white;font-weight:bold">${icon}</div>
                    <div class="neighbor-info">
                        <div class="neighbor-name" style="display:flex;align-items:center;gap:6px">
                            ${n.name}
                            ${isFav ? '<span style="color:#FFC107">‚≠ê</span>' : ''}
                        </div>
                        <div class="neighbor-activity" style="font-size:14px;color:var(--text-secondary)">
                            ${activityBadges}
                        </div>
                        <div class="neighbor-status" style="margin-top:4px">
                            ${statusBadge}
                        </div>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px">
                        ${actionButton}
                    </div>
                </div>`;
            }).join('');
        }

        // ===== Favorites =====
        function toggleFavorite(id, name) {
            if (state.favorites[id]) {
                delete state.favorites[id];
                showNotification('Removed from favorites', 'success');
            } else {
                state.favorites[id] = true;
                showNotification('Added to favorites! ‚≠ê', 'success');
            }
            savePrivateData();
            renderNeighbors();
        }

        // ===== Private Notes =====
        function showNoteModal(id, name) {
            state.noteTargetId = id;
            document.getElementById('noteModalName').textContent = name;
            document.getElementById('noteInput').value = state.privateNotes[id] || '';
            document.getElementById('noteModal').classList.add('active');
        }

        function saveNote() {
            const note = document.getElementById('noteInput').value.trim();
            if (note) {
                state.privateNotes[state.noteTargetId] = note;
                showNotification('Note saved! üìù', 'success');
            } else {
                delete state.privateNotes[state.noteTargetId];
            }
            savePrivateData();
            closeNoteModal();
            renderNeighbors();
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
        }

        function savePrivateData() {
            localStorage.setItem('goldenbuddy_data', JSON.stringify({
                favorites: state.favorites,
                privateNotes: state.privateNotes,
                ratings: state.ratings,
                connectionHistory: state.connectionHistory
            }));
        }

        // ===== Ratings =====
        function showRatingModal(buddyId, buddyName) {
            state.ratingTargetId = buddyId;
            state.ratingTargetName = buddyName;
            document.getElementById('ratingModalName').textContent = buddyName;
            document.getElementById('ratingModal').classList.add('active');
        }

        function submitRating(rating) {
            state.ratings[state.ratingTargetId] = {
                rating: rating,
                timestamp: Date.now()
            };
            savePrivateData();
            closeRatingModal();
            showNotification(rating === 'good' ? 'Thanks! Rated as Good üëç' : 'Noted. We\'ll remember.', 'success');
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').classList.remove('active');
        }

        // ===== Feedback System =====
        let selectedRating = 0;

        function showFeedbackModal() {
            selectedRating = 0;
            document.getElementById('feedbackText').value = '';
            document.getElementById('feedbackContact').checked = false;
            document.getElementById('submitFeedbackBtn').disabled = true;
            
            // Reset all rating buttons
            document.querySelectorAll('.feedback-rating').forEach(btn => {
                btn.style.background = 'white';
                btn.style.borderColor = 'var(--secondary)';
            });
            
            document.getElementById('feedbackModal').classList.add('active');
        }

        function selectFeedbackRating(rating) {
            selectedRating = rating;
            
            // Update button styles
            document.querySelectorAll('.feedback-rating').forEach(btn => {
                const btnRating = parseInt(btn.dataset.rating);
                if (btnRating === rating) {
                    btn.style.background = '#E3F2FD';
                    btn.style.borderColor = '#1976D2';
                } else {
                    btn.style.background = 'white';
                    btn.style.borderColor = 'var(--secondary)';
                }
            });
            
            // Enable submit button
            document.getElementById('submitFeedbackBtn').disabled = false;
        }

        function submitFeedback() {
            if (selectedRating === 0) {
                showNotification('Please select a rating', 'error');
                return;
            }
            
            const feedbackText = document.getElementById('feedbackText').value.trim();
            const canContact = document.getElementById('feedbackContact').checked;
            
            const feedback = {
                userId: state.userId || 'anonymous',
                userName: state.userData?.name || 'Anonymous',
                rating: selectedRating,
                text: feedbackText,
                canContact: canContact,
                timestamp: Date.now(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            // Save to Firebase
            if (window.db) {
                window.db.ref('feedback').push(feedback)
                    .then(() => {
                        closeFeedbackModal();
                        showNotification('‚úÖ Thank you for your feedback! We appreciate it.', 'success');
                    })
                    .catch(err => {
                        console.error('Feedback error:', err);
                        // Save locally as fallback
                        saveFeedbackLocally(feedback);
                        closeFeedbackModal();
                        showNotification('‚úÖ Feedback saved! We appreciate it.', 'success');
                    });
            } else {
                // Save locally if no Firebase
                saveFeedbackLocally(feedback);
                closeFeedbackModal();
                showNotification('‚úÖ Feedback saved! We appreciate it.', 'success');
            }
        }

        function saveFeedbackLocally(feedback) {
            const existingFeedback = JSON.parse(localStorage.getItem('goldenbuddy_feedback') || '[]');
            existingFeedback.push(feedback);
            localStorage.setItem('goldenbuddy_feedback', JSON.stringify(existingFeedback));
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('active');
        }

        // ===== Emergency System =====
        let emergencyContact = null;

        function loadEmergencyContact() {
            const saved = localStorage.getItem('goldenbuddy_emergency_contact');
            if (saved) {
                emergencyContact = JSON.parse(saved);
            }
        }

        function showEmergencyModal() {
            // Load emergency contact if not already loaded
            if (!emergencyContact) {
                loadEmergencyContact();
            }
            
            // Check if emergency contact is set up
            if (!emergencyContact || !emergencyContact.phone) {
                showEmergencySetupModal();
                return;
            }
            
            // Try to get location
            document.getElementById('emergencyLocation').textContent = 'Getting location...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(4);
                        const lng = position.coords.longitude.toFixed(4);
                        document.getElementById('emergencyLocation').textContent = `Lat: ${lat}, Lng: ${lng}`;
                        state.emergencyLocation = { lat, lng };
                    },
                    () => {
                        document.getElementById('emergencyLocation').textContent = 'Location not available';
                    },
                    { timeout: 10000 }
                );
            } else {
                document.getElementById('emergencyLocation').textContent = 'Location not supported';
            }
            
            document.getElementById('emergencyModal').classList.add('active');
        }

        function closeEmergencyModal() {
            document.getElementById('emergencyModal').classList.remove('active');
        }

        function showEmergencySetupModal() {
            document.getElementById('emergencySetupModal').classList.add('active');
        }

        function closeEmergencySetupModal() {
            document.getElementById('emergencySetupModal').classList.remove('active');
        }

        function saveEmergencyContact() {
            const name = document.getElementById('emergencyContactName').value.trim();
            const phone = document.getElementById('emergencyContactPhone').value.trim();
            
            if (!name || !phone) {
                showNotification('Please enter both name and phone number', 'error');
                return;
            }
            
            emergencyContact = { name, phone };
            localStorage.setItem('goldenbuddy_emergency_contact', JSON.stringify(emergencyContact));
            closeEmergencySetupModal();
            showNotification('‚úÖ Emergency contact saved!', 'success');
        }

        function callEmergency() {
            window.location.href = 'tel:911';
            logEmergencyAction('Called 911');
        }

        function callEmergencyContact() {
            if (!emergencyContact || !emergencyContact.phone) {
                showNotification('No emergency contact set up', 'error');
                showEmergencySetupModal();
                return;
            }
            window.location.href = 'tel:' + emergencyContact.phone;
            logEmergencyAction('Called emergency contact: ' + emergencyContact.name);
        }

        function textEmergencyContact() {
            if (!emergencyContact || !emergencyContact.phone) {
                showNotification('No emergency contact set up', 'error');
                showEmergencySetupModal();
                return;
            }
            
            let message = `EMERGENCY: I need help! This is ${state.userData?.name || 'your contact'}. `;
            
            if (state.emergencyLocation) {
                message += `My location: https://maps.google.com/?q=${state.emergencyLocation.lat},${state.emergencyLocation.lng} `;
            }
            
            if (state.connection && state.connection.name) {
                message += `I was meeting ${state.connection.name}. `;
            }
            
            message += 'Please call me!';
            
            window.location.href = `sms:${emergencyContact.phone}?body=${encodeURIComponent(message)}`;
            logEmergencyAction('Texted emergency contact: ' + emergencyContact.name);
        }

        function logEmergencyAction(action) {
            const log = {
                action: action,
                timestamp: Date.now(),
                userId: state.userId,
                userName: state.userData?.name || 'Unknown'
            };
            
            // Save to local history
            const history = JSON.parse(localStorage.getItem('goldenbuddy_emergency_log') || '[]');
            history.push(log);
            localStorage.setItem('goldenbuddy_emergency_log', JSON.stringify(history));
            
            // Also try to save to Firebase for safety monitoring
            if (window.db) {
                window.db.ref('emergency_logs').push(log).catch(() => {
                    // Silent fail - local storage is backup
                });
            }
            
            closeEmergencyModal();
        }

        // Load emergency contact on init
        loadEmergencyContact();

        function filterActivity(activity, btn) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            state.currentFilter = activity;
            renderNeighbors();
        }

        // ===== Invites =====
        function updateInviteCount() {
            const pending = state.invites.filter(i => i.status === 'pending').length;
            const badge = document.getElementById('inviteCount');
            badge.textContent = pending;
            badge.style.display = pending > 0 ? 'inline' : 'none';
        }

        function showInbox() {
            renderInvites();
            document.getElementById('inboxModal').classList.add('active');
        }

        function closeInbox() {
            document.getElementById('inboxModal').classList.remove('active');
        }

        function renderInvites(tab) {
            const container = document.getElementById('invitesList');
            const currentTab = tab || state.inboxTab || 'received';
            state.inboxTab = currentTab;
            
            const invites = state.invites || [];
            let filtered = [];
            
            if (currentTab === 'received') {
                filtered = invites.filter(i => i.direction !== 'sent');
            } else if (currentTab === 'sent') {
                filtered = invites.filter(i => i.direction === 'sent');
            } else if (currentTab === 'history') {
                filtered = invites.filter(i => i.status === 'accepted' || i.status === 'declined');
            }
            
            if (filtered.length === 0) {
                const emptyMessages = {
                    'received': 'No received invites',
                    'sent': 'No sent invites',
                    'history': 'No past connections'
                };
                container.innerHTML = `<p class="empty-state">${emptyMessages[currentTab]}</p>`;
                return;
            }

            const activityIcons = { 
                'Walking': 'üö∂', 'Chess': '‚ôüÔ∏è', 'Coffee': '‚òï', 
                'Bingo': 'üé±', 'Books': 'üìö', 'Exercise': 'üßò',
                'BoardGames': 'üé≤', 'Dancing': 'üíÉ', 'Art': 'üé®',
                'Gardening': 'üå±', 'Swimming': 'üèä'
            };
            
            container.innerHTML = filtered.map(invite => {
                const isSent = invite.direction === 'sent';
                const otherName = isSent ? invite.toName : invite.fromName;
                const statusClass = invite.status === 'accepted' ? 'accepted' : (invite.status === 'declined' ? 'declined' : 'pending');
                const activityIcon = activityIcons[invite.activity] || 'üë§';
                
                return `
                <div class="invite-item ${statusClass}" style="padding:16px;${isSent ? 'border-left-color: var(--primary)' : ''}">
                    <div style="display:flex;align-items:center;gap:12px;flex:1">
                        <div style="background:var(--secondary);width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px">
                            ${activityIcon}
                        </div>
                        <div class="invite-item-info">
                            <h4 style="margin:0 0 4px 0;font-size:16px">${otherName}</h4>
                            <p style="margin:0;font-size:13px;color:var(--text-secondary)">
                                ${activityIcon} ${invite.activity} ‚Ä¢ ${formatTime(invite.timestamp)}
                            </p>
                        </div>
                    </div>
                    <div class="invite-actions">
                        ${currentTab === 'received' && invite.status === 'pending' ? `
                            <div style="display:flex;gap:6px">
                                <button class="btn btn-accent btn-small" style="padding:8px 12px;font-size:14px" onclick="showSafetyAccept('${invite.key}', '${invite.fromId}', '${invite.fromName}', '${invite.activity}')">‚úì Accept</button>
                                <button class="btn btn-outline btn-small" style="padding:8px 12px;font-size:14px" onclick="declineInvite('${invite.key}')">‚úï</button>
                            </div>
                        ` : `
                            <span class="badge" style="font-size:12px">${invite.status === 'accepted' ? '‚úÖ Connected' : invite.status}</span>
                        `}
                    </div>
                </div>`;
            }).join('');
        }

        function switchInboxTab(tab, btn) {
            document.querySelectorAll('#inboxTabs .tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderInvites(tab);
        }

        function openInviteModal(id, name, activity) {
            // Check if currently connected to this person
            if (state.connection && state.connection.buddyId === id) {
                showNotification('You are currently connected with ' + name + '. End the connection first.', 'error');
                return;
            }
            
            // Check if already connected or pending
            const existingInvite = state.invites.find(invite => 
                (invite.fromId === id || invite.toId === id) && 
                (invite.status === 'pending' || invite.status === 'accepted')
            );
            
            if (existingInvite) {
                if (existingInvite.status === 'accepted') {
                    showNotification('You are already connected with ' + name, 'error');
                } else if (existingInvite.status === 'completed') {
                    // Allow re-inviting after connection completed
                    // Continue to invite modal
                } else {
                    showNotification('Invite already sent to ' + name, 'error');
                    return;
                }
            }
            
            state.selectedNeighbor = { id, name, activity };
            document.getElementById('inviteBuddyName').textContent = name;
            document.getElementById('inviteBuddyActivity').textContent = 'Looking for: ' + (activity || 'activity');
            document.getElementById('inviteActivityName').textContent = state.userData.activity;
            document.getElementById('inviteModal').classList.add('active');
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').classList.remove('active');
            state.selectedNeighbor = null;
        }

        // ===== Safety Modal =====
        function showSafetyModal(mode) {
            document.getElementById('inviteModal').classList.remove('active');
            state.pendingSafetyAction = { mode: mode };
            
            // Update suggested spots based on user's state
            const userState = state.userData?.state || 'VA';
            const spots = SAFE_ZONES[userState] || SAFE_ZONES['VA'];
            const spotsHtml = spots.slice(0, 5).map(s => '‚Ä¢ ' + s).join('<br>');
            document.getElementById('suggestedSpots').innerHTML = spotsHtml;
            
            document.getElementById('safetyProceedBtn').onclick = handleSafetyProceed;
            document.getElementById('safetyModal').classList.add('active');
        }

        function showSafetyAccept(key, fromId, fromName, activity) {
            document.getElementById('inboxModal').classList.remove('active');
            state.pendingSafetyAction = { 
                mode: 'accept', 
                key: key, 
                fromId: fromId, 
                fromName: fromName, 
                activity: activity 
            };
            
            // Update suggested spots based on user's state
            const userState = state.userData?.state || 'VA';
            const spots = SAFE_ZONES[userState] || SAFE_ZONES['VA'];
            const spotsHtml = spots.slice(0, 5).map(s => '‚Ä¢ ' + s).join('<br>');
            document.getElementById('suggestedSpots').innerHTML = spotsHtml;
            
            document.getElementById('safetyProceedBtn').onclick = handleSafetyProceed;
            document.getElementById('safetyModal').classList.add('active');
        }

        function handleSafetyProceed() {
            const action = state.pendingSafetyAction;
            closeSafetyModal();
            
            if (action.mode === 'send') {
                doSendInvite();
            } else if (action.mode === 'accept') {
                doAcceptInvite(action.key, action.fromId, action.fromName, action.activity);
            }
        }

        function closeSafetyModal() {
            document.getElementById('safetyModal').classList.remove('active');
            state.pendingSafetyAction = null;
        }

        function doSendInvite() {
            if (!state.selectedNeighbor) {
                showNotification('No neighbor selected', 'error');
                return;
            }

            if (!window.db) {
                showNotification('Database not connected. Check your internet.', 'error');
                return;
            }

            const invite = {
                fromId: state.userId,
                fromName: state.userData.name,
                toId: state.selectedNeighbor.id,
                toName: state.selectedNeighbor.name,
                activity: state.userData.activity,
                status: 'pending',
                timestamp: Date.now()
            };

            const newRef = window.db.ref('invites/' + state.selectedNeighbor.id).push();
            const inviteKey = newRef.key;
            
            // Show sending feedback immediately
            showNotification('üì® Sending invite...', 'success');
            
            // First save to receiver
            window.db.ref('invites/' + state.selectedNeighbor.id + '/' + inviteKey).set(invite)
                .then(() => {
                    // Then save to sender
                    return window.db.ref('invites/' + state.userId + '/' + inviteKey).set({
                        ...invite, 
                        status: 'sent', 
                        direction: 'sent',
                        key: inviteKey
                    });
                })
                .then(() => {
                    // Add to local state immediately
                    state.invites.push({
                        ...invite,
                        key: inviteKey,
                        status: 'sent',
                        direction: 'sent'
                    });
                    
                    // Success feedback
                    closeInviteModal();
                    showNotification(`‚úÖ Invite sent to ${state.selectedNeighbor.name}!`, 'success');
                    
                    // Refresh neighbors to show "waiting" status
                    renderNeighbors();
                })
                .catch(err => {
                    console.error('Invite error:', err);
                    showNotification('Failed to send invite. Check connection.', 'error');
                });
        }

        function cancelInvite(key, neighborId) {
            if (confirm('Cancel this invite?')) {
                window.db.ref('invites/' + neighborId + '/' + key).remove();
                window.db.ref('invites/' + state.userId + '/' + key).remove();
                showNotification('Invite cancelled', 'success');
                renderNeighbors();
            }
        }

        function enterConnectionWith(id, name, activity) {
            state.connection = { buddyId: id, name: name, activity, connectedAt: Date.now() };
            enterConnectionRoom();
        }

        function doAcceptInvite(key, fromId, fromName, activity) {
            if (!window.db) {
                showNotification('Database not connected', 'error');
                return;
            }

            const connectionKey = [state.userId, fromId].sort().join('_');

            // Update both invites to accepted
            window.db.ref('invites/' + state.userId + '/' + key).update({ status: 'accepted' })
                .then(() => {
                    return window.db.ref('invites/' + fromId + '/' + key).update({ status: 'accepted' });
                })
                .then(() => {
                    // Create shared connection in Firebase so both users see it
                    return window.db.ref('connections/' + connectionKey).set({
                        user1: state.userId,
                        user2: fromId,
                        user1Name: state.userData.name,
                        user2Name: fromName,
                        status: 'active',
                        activity: activity,
                        startedAt: Date.now()
                    });
                })
                .then(() => {
                    state.connection = { 
                        buddyId: fromId, 
                        name: fromName, 
                        activity,
                        connectedAt: Date.now()
                    };
                    
                    // Add to connection history
                    const historyEntry = {
                        buddyId: fromId,
                        buddyName: fromName,
                        activity: activity,
                        connectedAt: Date.now(),
                        endedAt: null
                    };
                    state.connectionHistory.unshift(historyEntry);
                    savePrivateData();
                    
                    closeInbox();
                    showView('dashboardView');
                    renderNeighbors();
                    showNotification('‚úÖ Connected! You can now chat with ' + fromName, 'success');
                })
                .catch(err => {
                    console.error('Accept error:', err);
                    showNotification('Failed to accept. Try again.', 'error');
                });
        }

        function acceptInvite(key, fromId, fromName, activity) {
            // Now handled by showSafetyAccept - this is kept for compatibility
            showSafetyAccept(key, fromId, fromName, activity);
        }

        function declineInvite(key) {
            window.db.ref('invites/' + state.userId + '/' + key).update({ status: 'declined' });
        }

        // ===== Connection Room =====
        function enterConnectionRoom() {
            const color = getDailyColor(state.connection.buddyId);
            
            // Set buddy info
            document.getElementById('buddyName').textContent = state.connection.name;
            document.getElementById('buddyActivity').textContent = 'Activity: ' + state.connection.activity;
            
            // Set avatar letter
            const initial = state.connection.name.charAt(0).toUpperCase();
            if (document.getElementById('buddyAvatar')) {
                document.getElementById('buddyAvatar').textContent = initial;
            }
            
            // Set color to look for
            document.getElementById('dailyColorText').textContent = color + ' icon';
            
            // Populate meeting spots dropdown based on user's state
            const userState = state.userData?.state || 'VA';
            const spots = SAFE_ZONES[userState] || SAFE_ZONES['VA'];
            const select = document.getElementById('meetingSpotSelect');
            select.innerHTML = '<option value="">Select a meeting spot...</option>';
            
            spots.forEach(spot => {
                const option = document.createElement('option');
                option.value = spot;
                option.textContent = spot;
                select.appendChild(option);
            });
            
            // Reset meeting spot text
            document.getElementById('meetingSpot').textContent = 'Select a spot above';
            document.getElementById('theirSpot').textContent = 'Waiting for buddy to pick...';
            document.getElementById('theirSpotCard').style.display = 'block';
            
            // Listen for buddy's suggested spot
            if (window.db && state.connection) {
                const connectionKey = [state.userId, state.connection.buddyId].sort().join('_');
                
                // Clean up old listener if exists
                if (state.meetingSpotListener) {
                    window.db.ref('meetingSpots/' + connectionKey).off('value', state.meetingSpotListener);
                }
                
                state.meetingSpotListener = window.db.ref('meetingSpots/' + connectionKey).on('value', (snapshot) => {
                    const data = snapshot.val();
                    console.log('Meeting spots data:', data);
                    
                    if (data) {
                        const myData = data[state.userId];
                        const buddyId = state.connection.buddyId;
                        const buddyData = data[buddyId];
                        
                        // Show my selected spot
                        if (myData && myData.spot) {
                            document.getElementById('meetingSpot').textContent = myData.spot;
                            document.getElementById('timeSection').style.display = 'block';
                            populateTimeSelects();
                            
                            // If I set a time, show it
                            if (myData.meetingTime && myData.meetingTimeString) {
                                document.getElementById('timeConfirmed').style.display = 'block';
                                document.getElementById('confirmedTime').textContent = 'üìÖ ' + myData.meetingTimeString;
                            }
                        }
                        
                        // Show buddy's spot
                        if (buddyData) {
                            console.log('Buddy data:', buddyData);
                            
                            if (buddyData.spot) {
                                document.getElementById('theirSpot').innerHTML = '<strong>' + buddyData.name + ' suggests:</strong><br>üìç ' + buddyData.spot;
                                document.getElementById('theirSpotCard').style.display = 'block';
                                document.getElementById('acceptTheirSpot').style.display = 'block';
                                document.getElementById('timeSection').style.display = 'block';
                                populateTimeSelects();
                            }
                            
                            // If buddy set a time, show it
                            if (buddyData.meetingTime && buddyData.meetingTimeString) {
                                document.getElementById('theirTime').style.display = 'block';
                                document.getElementById('theirTimeText').textContent = buddyData.name + ' set time: ' + buddyData.meetingTimeString;
                                
                                // If I haven't set a time yet, show buddy's countdown
                                if (!myData || !myData.meetingTime) {
                                    startCountdown(buddyData.meetingTime, buddyData.meetingTimeString);
                                }
                            }
                        }
                    }
                }, (error) => {
                    console.error('Meeting spot listener error:', error);
                });
                
                // Listen for connection ended by other user
                window.db.ref('connections/' + connectionKey + '/endedBy').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.userId !== state.userId) {
                        showNotification(buddyName + ' ended the connection', 'error');
                        
                        // Clean up
                        if (state.meetingSpotListener) {
                            window.db.ref('meetingSpots/' + connectionKey).off('value', state.meetingSpotListener);
                            state.meetingSpotListener = null;
                        }
                        
                        if (countdownInterval) {
                            clearInterval(countdownInterval);
                            countdownInterval = null;
                        }
                        
                        state.connection = null;
                        showView('dashboardView');
                        renderNeighbors();
                    }
                });
            }
            
            showView('connectionView');
            showNotification('üéâ Connected with ' + state.connection.name + '!\n\nLook for the ' + color + ' icon!', 'success');
        }

        function updateMeetingSpot() {
            const select = document.getElementById('meetingSpotSelect');
            const spot = select.value;
            document.getElementById('meetingSpot').textContent = spot;
            
            // Save to Firebase so the other person can see it
            if (spot && state.connection && window.db) {
                state.connection.meetingSpot = spot;
                
                const connectionKey = [state.userId, state.connection.buddyId].sort().join('_');
                
                // Save your spot choice and reset time
                window.db.ref('meetingSpots/' + connectionKey + '/' + state.userId).set({
                    spot: spot,
                    name: state.userData.name,
                    spotAccepted: false,
                    timeAccepted: false,
                    meetingTime: null,
                    timestamp: Date.now()
                }).then(() => {
                    showNotification('üìç Meeting spot shared!', 'success');
                    // Show time section
                    document.getElementById('timeSection').style.display = 'block';
                    populateTimeSelects();
                }).catch(err => {
                    console.error('Meeting spot error:', err);
                    showNotification('Could not share spot. Try again.', 'error');
                });
            } else if (!window.db) {
                showNotification('Database not connected', 'error');
            }
        }

        function populateTimeSelects() {
            const hourSelect = document.getElementById('meetingHour');
            const minuteSelect = document.getElementById('meetingMinute');
            
            hourSelect.innerHTML = '<option value="">Hour</option>';
            minuteSelect.innerHTML = '<option value="">Min</option>';
            
            for (let i = 6; i <= 11; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i;
                hourSelect.appendChild(opt);
            }
            
            for (let i = 0; i <= 55; i += 5) {
                const opt = document.createElement('option');
                opt.value = i.toString().padStart(2, '0');
                opt.textContent = i.toString().padStart(2, '0');
                minuteSelect.appendChild(opt);
            }
        }

        function setMeetingTime() {
            const hour = document.getElementById('meetingHour').value;
            const minute = document.getElementById('meetingMinute').value;
            const ampm = document.getElementById('meetingAMPM').value;
            
            if (!hour || !minute) {
                showNotification('Please pick a time', 'error');
                return;
            }
            
            // Calculate meeting time
            let hour24 = parseInt(hour);
            if (ampm === 'PM' && hour24 !== 12) hour24 += 12;
            if (ampm === 'AM' && hour24 === 12) hour24 = 0;
            
            const now = new Date();
            let meetingTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour24, parseInt(minute), 0);
            
            // If time has passed today, set for tomorrow
            if (meetingTime < now) {
                meetingTime.setDate(meetingTime.getDate() + 1);
            }
            
            const timeString = `${hour}:${minute} ${ampm}`;
            const meetingTimestamp = meetingTime.getTime();
            
            // Save to Firebase
            const connectionKey = [state.userId, state.connection.buddyId].sort().join('_');
            
            window.db.ref('meetingSpots/' + connectionKey + '/' + state.userId).update({
                meetingTime: meetingTimestamp,
                meetingTimeString: timeString,
                timeAccepted: false
            }).then(() => {
                showNotification('‚è∞ Meeting time set!', 'success');
                startCountdown(meetingTimestamp, timeString);
            }).catch(err => {
                console.error('Time error:', err);
                showNotification('Could not set time', 'error');
            });
        }

        let countdownInterval = null;

        function startCountdown(meetingTimestamp, timeString) {
            // Show confirmed time section
            document.getElementById('timeConfirmed').style.display = 'block';
            document.getElementById('confirmedTime').textContent = 'üìÖ ' + timeString;
            
            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                const now = Date.now();
                const diff = meetingTimestamp - now;
                
                if (diff <= 0) {
                    document.getElementById('countdown').textContent = 'üéâ Time to meet!';
                    clearInterval(countdownInterval);
                    return;
                }
                
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                
                if (hours > 0) {
                    document.getElementById('countdown').textContent = hours + 'h ' + minutes + 'm remaining';
                } else {
                    document.getElementById('countdown').textContent = minutes + ' minutes remaining';
                }
            }, 60000); // Update every minute
            
            // Initial update
            const now = Date.now();
            const diff = meetingTimestamp - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            if (hours > 0) {
                document.getElementById('countdown').textContent = hours + 'h ' + minutes + 'm remaining';
            } else {
                document.getElementById('countdown').textContent = minutes + ' minutes remaining';
            }
        }

        function acceptTheirSpot() {
            const spot = document.getElementById('theirSpot').textContent.replace('suggests:\nüìç ', '');
            const connectionKey = [state.userId, state.connection.buddyId].sort().join('_');
            
            // Update to accept their spot
            window.db.ref('meetingSpots/' + connectionKey + '/' + state.userId).update({
                spotAccepted: true,
                spot: spot
            });
            
            showNotification('‚úÖ Spot accepted!', 'success');
        }

        function textFamily() {
            const spot = document.getElementById('meetingSpot').textContent;
            const message = `I have arrived at ${spot} for my GoldenBuddy ${state.connection.activity}.`;
            window.location.href = `sms:?body=${encodeURIComponent(message)}`;
        }

        function endConnection() {
            const buddyId = state.connection?.buddyId;
            const buddyName = state.connection?.name;
            const connectionKey = state.connection?.key || (buddyId ? [state.userId, buddyId].sort().join('_') : null);
            
            // Notify the other user that connection ended
            if (window.db && connectionKey) {
                // Mark connection as ended in Firebase
                window.db.ref('connections/' + connectionKey).update({
                    status: 'ended',
                    endedBy: {
                        userId: state.userId,
                        name: state.userData.name,
                        timestamp: Date.now()
                    },
                    endedAt: Date.now()
                });
                
                // Update invite status to 'completed' so they can reconnect later
                if (buddyId) {
                    const invite = state.invites.find(i => 
                        (i.fromId === buddyId || i.toId === buddyId) && 
                        i.status === 'accepted'
                    );
                    if (invite && invite.key) {
                        // Update both sides
                        window.db.ref('invites/' + state.userId + '/' + invite.key).update({ status: 'completed' });
                        window.db.ref('invites/' + buddyId + '/' + invite.key).update({ status: 'completed' });
                        // Update local state
                        invite.status = 'completed';
                    }
                }
                
                // Clean up meeting spot listener
                if (state.meetingSpotListener) {
                    window.db.ref('meetingSpots/' + connectionKey).off('value', state.meetingSpotListener);
                    state.meetingSpotListener = null;
                }
                
                // Clean up meeting spots data
                window.db.ref('meetingSpots/' + connectionKey).remove();
            }
            
            // Stop countdown
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            // Update connection history
            if (buddyId && state.connectionHistory) {
                const historyEntry = state.connectionHistory.find(h => h.buddyId === buddyId && !h.endedAt);
                if (historyEntry) {
                    historyEntry.endedAt = Date.now();
                    historyEntry.duration = historyEntry.endedAt - historyEntry.connectedAt;
                    savePrivateData();
                }
            }
            
            // Clear connection state completely
            state.connection = null;
            
            // Reset all UI elements
            const timeSection = document.getElementById('timeSection');
            const timeConfirmed = document.getElementById('timeConfirmed');
            const theirTime = document.getElementById('theirTime');
            const theirSpotCard = document.getElementById('theirSpotCard');
            const acceptTheirSpot = document.getElementById('acceptTheirSpot');
            
            if (timeSection) timeSection.style.display = 'none';
            if (timeConfirmed) timeConfirmed.style.display = 'none';
            if (theirTime) theirTime.style.display = 'none';
            if (theirSpotCard) theirSpotCard.style.display = 'none';
            if (acceptTheirSpot) acceptTheirSpot.style.display = 'none';
            
            // Go back to dashboard
            showView('dashboardView');
            
            // Refresh neighbors to update status
            renderNeighbors();
            
            // Ask for rating
            if (buddyId) {
                showRatingModal(buddyId, buddyName);
            }
        }

        // ===== Profile =====
        function showProfile() {
            document.getElementById('profileAvatar').textContent = state.userData.name.charAt(0).toUpperCase();
            document.getElementById('profileName').textContent = state.userData.name;
            document.getElementById('profileArea').textContent = (state.userData.areaName || state.userData.area) + ', ' + (state.userData.state || '');
            
            renderHistory();
            document.getElementById('profileModal').classList.add('active');
        }

        function closeProfile() {
            document.getElementById('profileModal').classList.remove('active');
        }

        function showEditProfile() {
            document.getElementById('profileModal').classList.remove('active');
            
            document.getElementById('editNameInput').value = state.userData.name;
            document.getElementById('editStateSelect').value = state.userData.state || 'VA';
            updateEditAreas();
            document.getElementById('editAreaSelect').value = state.userData.state + '|' + (state.userData.area.split('|')[1] || state.userData.area);
            
            // Set current activity
            document.querySelectorAll('#editActivityIcons .activity-btn').forEach(b => {
                b.classList.remove('selected');
                if (b.dataset.activity === state.userData.activity) {
                    b.classList.add('selected');
                }
            });
            
            document.getElementById('editProfileModal').classList.add('active');
        }

        function updateEditAreas() {
            const stateSelect = document.getElementById('editStateSelect');
            const areaSelect = document.getElementById('editAreaSelect');
            const selectedState = stateSelect.value;
            
            areaSelect.innerHTML = '';
            
            if (selectedState && AREAS_BY_STATE[selectedState]) {
                const areas = AREAS_BY_STATE[selectedState];
                for (const [key, name] of Object.entries(areas)) {
                    const option = document.createElement('option');
                    option.value = selectedState + '|' + key;
                    option.textContent = name;
                    areaSelect.appendChild(option);
                }
            }
        }

        function toggleEditActivity(btn) {
            btn.classList.toggle('selected');
        }

        function selectEditActivity(btn) {
            // For compatibility with single-select
            document.querySelectorAll('#editActivityIcons .activity-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        function saveEditProfile() {
            const name = document.getElementById('editNameInput').value.trim();
            const areaValue = document.getElementById('editAreaSelect').value;
            
            if (!name) { showNotification('Please enter your name', 'error'); return; }
            if (!areaValue) { showNotification('Please select your area', 'error'); return; }
            
            // Get selected activities
            const selectedActivities = [];
            document.querySelectorAll('#editActivityIcons .activity-btn.selected').forEach(btn => {
                selectedActivities.push(btn.dataset.activity);
            });
            
            if (selectedActivities.length === 0) { 
                showNotification('Please select at least one activity', 'error'); 
                return; 
            }
            
            const [stateCode, areaKey] = areaValue.split('|');
            const areaName = AREAS_BY_STATE[stateCode]?.[areaKey] || areaValue;
            
            // Update user data
            state.userData.name = name;
            state.userData.state = stateCode;
            state.userData.area = areaValue;
            state.userData.areaName = areaName;
            state.userData.activities = selectedActivities;
            state.userData.activity = selectedActivities[0];
            
            localStorage.setItem('goldenbuddy_user', JSON.stringify(state.userData));
            
            // Update Firebase presence
            if (state.presenceRef) {
                state.presenceRef.update({
                    name: name,
                    state: stateCode,
                    area: areaValue,
                    areaName: areaName,
                    activities: state.userData.activities,
                    activity: state.userData.activity
                });
            }
            
            closeEditProfile();
            showProfile();
            showNotification('Profile updated!', 'success');
        }

        function closeEditProfile() {
            document.getElementById('editProfileModal').classList.remove('active');
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            
            if (state.invites.length === 0) {
                container.innerHTML = '<p style="color:var(--text-secondary)">No invite history yet</p>';
                return;
            }

            container.innerHTML = state.invites.map(invite => `
                <div class="history-item ${invite.direction || 'received'}">
                    <div><strong>${invite.direction === 'sent' ? 'Sent to' : 'From'}: ${invite.direction === 'sent' ? invite.toName : invite.fromName}</strong></div>
                    <div>${invite.activity} ‚Ä¢ <span class="time">${formatTime(invite.timestamp)}</span></div>
                </div>
            `).join('');
        }

        function logout() {
            if (state.presenceRef) state.presenceRef.remove();
            localStorage.removeItem('goldenbuddy_user');
            location.reload();
        }

        // ===== Utilities =====
        function generateId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let id = '';
            for (let i = 0; i < 5; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return id;
        }

        function getDailyColor(userId) {
            let hash = 0;
            for (let i = 0; i < userId.length; i++) {
                hash = userId.charCodeAt(i) + ((hash << 5) - hash);
            }
            return COLORS[Math.abs(hash) % COLORS.length];
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        }

        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        init();
    </script>
</body>
</html>
